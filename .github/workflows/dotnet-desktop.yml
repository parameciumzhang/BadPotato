name: Build BadPotato

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # ===== 关键修复：将目标框架改为 4.6.2（runner 上已有） =====
      - name: Retarget to .NET Framework 4.6.2
        run: |
          $csproj = "BadPotato.csproj"
          $content = Get-Content $csproj -Raw
          
          # 替换目标框架版本 v4.0 -> v4.6.2
          $content = $content -replace '<TargetFrameworkVersion>v4\.0</TargetFrameworkVersion>', '<TargetFrameworkVersion>v4.6.2</TargetFrameworkVersion>'
          
          Set-Content $csproj $content
          
          echo "修改后的目标框架："
          Select-String -Path $csproj -Pattern "TargetFrameworkVersion"
        shell: pwsh

      - name: Build (Release)
        run: |
          msbuild BadPotato.csproj /p:Configuration=Release /p:Platform=AnyCPU
        shell: pwsh

      - name: List output files
        run: |
          echo "===== 编译输出 ====="
          Get-ChildItem -Recurse -Path bin/Release
        shell: pwsh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BadPotato-Release
          path: |
            **/bin/Release/**/*.exe
            **/bin/Release/**/*.dll
